!function(t){var e={};function s(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,s),a.l=!0,a.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)s.d(i,a,function(e){return t[e]}.bind(null,a));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([function(t,e,s){},function(t,e,s){"use strict";s.r(e);s(0);function i(t,e){return t?t===e-1?"top-right":t<e?"top":t===e*(e-1)?"bottom-left":t%e?t===e**2-1?"bottom-right":(t+1)%e?t>e*(e-1)?"bottom":"center":"right":"left":"top-left"}class a{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(t){if(!(t instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=t}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",t=>this.onNewGameClick(t)),this.saveGameEl.addEventListener("click",t=>this.onSaveGameClick(t)),this.loadGameEl.addEventListener("click",t=>this.onLoadGameClick(t)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const e=document.createElement("div");e.classList.add("cell","map-tile","map-tile-"+i(t,this.boardSize)),e.addEventListener("mouseenter",t=>this.onCellEnter(t)),e.addEventListener("mouseleave",t=>this.onCellLeave(t)),e.addEventListener("click",t=>this.onCellClick(t)),this.boardEl.appendChild(e)}this.cells=Array.from(this.boardEl.children)}redrawPositions(t){for(const t of this.cells)t.innerHTML="";for(const s of t){const t=this.boardEl.children[s.position],i=document.createElement("div");i.classList.add("character",s.character.type);const a=document.createElement("div");a.classList.add("health-level");const o=document.createElement("div");o.classList.add("health-level-indicator","health-level-indicator-"+((e=s.character.health)<15?"critical":e<50?"normal":"high")),o.style.width=s.character.health+"%",a.appendChild(o),i.appendChild(a),t.appendChild(i)}var e}addCellEnterListener(t){this.cellEnterListeners.push(t)}addCellLeaveListener(t){this.cellLeaveListeners.push(t)}addCellClickListener(t){this.cellClickListeners.push(t)}addNewGameListener(t){this.newGameListeners.push(t)}addSaveGameListener(t){this.saveGameListeners.push(t)}addLoadGameListener(t){this.loadGameListeners.push(t)}onCellEnter(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellEnterListeners.forEach(t=>t.call(null,e))}onCellLeave(t){t.preventDefault();const e=this.cells.indexOf(t.currentTarget);this.cellLeaveListeners.forEach(t=>t.call(null,e))}onCellClick(t){const e=this.cells.indexOf(t.currentTarget);this.cellClickListeners.forEach(t=>t.call(null,e))}onNewGameClick(t){t.preventDefault(),this.newGameListeners.forEach(t=>t.call(null))}onSaveGameClick(t){t.preventDefault(),this.saveGameListeners.forEach(t=>t.call(null))}onLoadGameClick(t){t.preventDefault(),this.loadGameListeners.forEach(t=>t.call(null))}static showError(t){alert(t)}static showMessage(t){alert(t)}selectCell(t,e="yellow"){this.deselectCell(t),this.cells[t].classList.add("selected","selected-"+e)}deselectCell(t){const e=this.cells[t];e.classList.remove(...Array.from(e.classList).filter(t=>t.startsWith("selected")))}showCellTooltip(t,e){this.cells[e].title=t}hideCellTooltip(t){this.cells[t].title=""}showDamage(t,e){return new Promise(s=>{const i=this.cells[t],a=document.createElement("span");a.textContent=e,a.classList.add("damage"),i.appendChild(a),a.addEventListener("animationend",()=>{i.removeChild(a),s()})})}setCursor(t){this.boardEl.style.cursor=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}function o(t,e,s){const i=[],a=Math.floor(t/s),o=t%s;for(let t=1;t<=e;t+=1)o+t<s&&i.push(a*s+(o+t)),o-t>=0&&i.push(a*s+(o-t)),a+t<s&&i.push((a+t)*s+o),a-t>=0&&i.push((a-t)*s+o),a+t<s&&o+t<s&&i.push((a+t)*s+(o+t)),a-t>=0&&o-t>=0&&i.push((a-t)*s+(o-t)),a+t<s&&o-t>=0&&i.push((a+t)*s+(o-t)),a-t>=0&&o+t<s&&i.push((a-t)*s+(o+t));return console.log(i),i}function r(t,e,s){const i=[];let a=[];for(let t=0;t<s**2;t+=1)a.push(t),a.length===s&&(i.push(a),a=[]);const o=Math.ceil((t-t%s)/s),r=t%s;let n=o-e;n<0&&(n=0);let c=o+e;c>s-1&&(c=s-1);let h=r-e;h<0&&(h=0);let l=r+e;l>s-1&&(l=s-1);const u=[];for(let t=n;t<=c;t+=1)for(let e=h;e<=l;e+=1)u.push(i[t][e]);return u}function n(t=0){return 8*Math.floor(8*Math.random())+(Math.floor(2*Math.random())+t)}function c(t,e){return Math.floor(Math.max(t,t*(1.8-e/100)))}class h{constructor(t,e="generic"){if(this.level=t,this.attack=0,this.defence=0,this.health=50,this.type=e,new.target===h)throw new Error("Ошибка создания класса")}}class l extends h{constructor(t){super(t),this.type="bowman",this.attack=25,this.defence=25,this.distance=2,this.distanceAttack=2}}class u extends h{constructor(t){super(t),this.type="swordsman",this.attack=40,this.defence=10,this.distance=4,this.distanceAttack=1}}class d extends h{constructor(t){super(t),this.type="daemon",this.attack=10,this.defence=40,this.distance=1,this.distanceAttack=4}}class m extends h{constructor(t){super(t),this.type="magician",this.attack=10,this.defence=40,this.distance=1,this.distanceAttack=4}}class p extends h{constructor(t){super(t),this.type="undead",this.attack=40,this.defence=10,this.distance=4,this.distanceAttack=1}}class f extends h{constructor(t){super(t),this.type="vampire",this.attack=25,this.defence=25,this.distance=2,this.distanceAttack=2}}const g=[l,u,m,d,p,f],P=[l,u],v=[l,u,m],y=[d,p,f];var C=new class{constructor(){this.allCharacters=g,this.userTeamTwo=P,this.userTeamThree=v,this.computerTeam=y}};function b(t,e,s){const i=[],a=function*(t,e){for(;;){const s=Math.floor(Math.random()*t.length),i=Math.floor(Math.random()*e+1);yield new t[s](i)}}(t,e);for(let t=0;t<s;t+=1)i.push(a.next().value);return i}class w{constructor(t,e){if(!(t instanceof h))throw new Error("character must be instance of Character or its children");if("number"!=typeof e)throw new Error("position must be a number");this.character=t,this.position=e}}var T={auto:"auto",pointer:"pointer",crosshair:"crosshair",notallowed:"not-allowed"};const k="🎖",L="⚔",M="🛡",E="❤";var G={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"};class S{static from(t){return"object"==typeof t?t:null}}let x,A,X,O=0;const Y=new a;Y.bindToDOM(document.querySelector("#game-container"));const D=new class{constructor(t){this.storage=t}save(t){this.storage.setItem("state",JSON.stringify(t))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(t){throw new Error("Invalid state")}}}(localStorage);new class{constructor(t,e){this.gamePlay=t,this.stateService=e,this.currentTheme=G.prairie,this.currentCharacter={},this.selectedCell=!1,this.stage=1,this.blockGame=!1,this.score=0,this.userPositions=[],this.cpuPositions=[]}init(){this.letsPlay(),this.events()}letsPlay(){switch(this.run="user",this.stage){case 1:this.userTeams=b(C.userTeamTwo,1,2),this.computerTeams=b(C.computerTeam,1,2),this.setPositionCharacter(this.userTeams,this.computerTeams);break;case 2:this.currentTheme=G.desert,this.userTeams=b(C.userTeamThree,1,1),this.computerTeams=b(C.computerTeam,2,this.userTeams.length+this.userPositions.length),this.setPositionCharacter(this.userTeams,this.computerTeams),a.showMessage("Уровень 2");break;case 3:this.currentTheme=G.arctic,this.userTeams=b(C.userTeamThree,2,2),this.computerTeams=b(C.computerTeam,3,this.userTeams.length+this.userPositions.length),this.setPositionCharacter(this.userTeams,this.computerTeams),a.showMessage("Уровень 3");break;case 4:this.currentTheme=G.mountain,this.userTeams=b(C.userTeamThree,3,2),this.computerTeams=b(C.computerTeam,4,this.userTeams.length+this.userPositions.length),this.setPositionCharacter(this.userTeams,this.computerTeams),a.showMessage("Уровень 4");break;default:this.blockGame=!0,a.showMessage("Победа! Ваши баллы: "+this.score)}if(!this.blockGame){const t=function(t){let e;const s={user:[],computer:[]};for(let i=0;i<t;i+=1){do{e=n()}while(s.user.includes(e));s.user.push(e);do{e=n(6)}while(s.computer.includes(e));s.computer.push(e)}return s}(this.userPositions.length);for(let e=0;e<this.userPositions.length;e+=1)this.userPositions[e].position=t.user[e],this.cpuPositions[e].position=t.computer[e];this.gamePlay.drawUi(this.currentTheme),this.gamePlay.redrawPositions([...this.userPositions,...this.cpuPositions])}}setPositionCharacter(t,e){for(let e=0;e<t.length;e+=1)this.userPositions.push(new w(t[e],0));for(let t=0;t<e.length;t+=1)this.cpuPositions.push(new w(e[t],0))}events(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this))}async onCellClick(t){if(this.index=t,!this.blockGame)if(-1!==this.checkPosition(this.userPositions))this.gamePlay.deselectCell(O),this.gamePlay.selectCell(t),O=t,this.currentCharacter=[...this.userPositions].find(e=>e.position===t),this.selectedCell=!0;else if(this.selectedCell&&"pointer"===this.gamePlay.boardEl.style.cursor)this.currentCharacter.position=t,this.gamePlay.deselectCell(O),this.gamePlay.deselectCell(t),this.selectedCell=!1,this.gamePlay.redrawPositions([...this.userPositions,...this.cpuPositions]),this.run="computer",this.strategyComputer();else if(this.selectedCell&&"crosshair"===this.gamePlay.boardEl.style.cursor){const e=[...this.cpuPositions].find(e=>e.position===t);this.gamePlay.deselectCell(O),this.gamePlay.deselectCell(t),this.gamePlay.setCursor(T.auto),await this.actionAttack(this.currentCharacter.character,e),this.cpuPositions.length>0&&this.strategyComputer()}else a.showError("Выбирите вашего персонажа!")}onCellEnter(t){if(this.index=t,!this.blockGame)for(const s of[...this.userPositions,...this.cpuPositions])if(s.position===t&&this.gamePlay.showCellTooltip((e=s.character,`${k}${e.level} ${L}${e.attack} ${M}${e.defence} ${E}${e.health}`),t),-1!==this.checkPosition([...this.userPositions])&&this.gamePlay.setCursor(T.pointer),this.selectedCell){A=this.currentCharacter.position,x=this.currentCharacter.character.distance,X=this.gamePlay.boardSize;const e=o(A,x,X);x=this.currentCharacter.character.distanceAttack;const s=r(A,x,X);-1!==this.checkPosition(this.userPositions)?this.gamePlay.setCursor(T.pointer):e.includes(t)&&-1===this.checkPosition([...this.userPositions,...this.cpuPositions])?(this.gamePlay.selectCell(t,"green"),this.gamePlay.setCursor(T.pointer)):s.includes(t)&&-1!==this.checkPosition(this.cpuPositions)?(this.gamePlay.selectCell(t,"red"),this.gamePlay.setCursor(T.crosshair)):this.gamePlay.setCursor(T.notallowed)}var e}onCellLeave(t){this.currentCharacter.position!==t&&this.gamePlay.deselectCell(t),this.gamePlay.hideCellTooltip(t),this.gamePlay.setCursor(T.auto)}checkPosition(t){return t.findIndex(t=>t.position===this.index)}async actionAttack(t,e){const s=e.character;let i=Math.max(t.attack-s.defence,.1*t.attack);if(i=Math.floor(i),await this.gamePlay.showDamage(e.position,i),s.health-=i,this.run="computer"===this.run?"user":"computer",s.health<=0&&(this.userPositions=this.userPositions.filter(t=>t.position!==e.position),this.cpuPositions=this.cpuPositions.filter(t=>t.position!==e.position),0===this.userPositions.length&&(a.showMessage("Вы проиграли :("),this.blockGame=!0),0===this.cpuPositions.length)){for(const t of this.userPositions)this.score+=t.character.health;this.levelUp(),this.stage+=1,this.letsPlay()}this.gamePlay.redrawPositions([...this.userPositions,...this.cpuPositions])}levelUp(){for(const t of this.userPositions)t.character.level+=1,t.character.attack=c(t.character.attack,t.character.health),t.character.defence=c(t.character.defence,t.character.health),t.character.health=t.character.health+80<100?t.character.health+80:100}strategyComputer(){for(const t of[...this.cpuPositions]){x=t.character.distanceAttack,A=t.position,X=this.gamePlay.boardSize;const e=r(A,x,X),s=this.computerAttack(e);if(null!==s)return void this.computersAttack(t.character,s)}const t=Math.floor(Math.random()*[...this.cpuPositions].length),e=[...this.cpuPositions][t];this.actionMove(e),this.gamePlay.redrawPositions([...this.userPositions,...this.cpuPositions]),this.run="user"}computerAttack(t){for(const e of[...this.userPositions])if(t.includes(e.position))return e;return null}async computersAttack(t,e){await this.actionAttack(t,e)}actionMove(t){const e=t,s=e.character.distance,i=this.checkStr(e.position),a=this.checkColumn(e.position);let o,r,n,c,h,l={};for(const t of[...this.userPositions]){const e=this.checkStr(t.position),s=this.checkColumn(t.position);o=i-e,r=a-s,n=Math.abs(o)+Math.abs(r),(void 0===l.distance||n<l.distance)&&(l={distanceX:o,distanceY:r,distance:n,locX:e,locY:s,type:t.character.type})}Math.abs(l.distanceX)===Math.abs(l.distanceY)?Math.abs(l.distanceX)>s?(c=i-s*Math.sign(l.distanceX),h=a-s*Math.sign(l.distanceY),e.position=this.moveTo(c,h)):(c=i-(l.distanceX-1*Math.sign(l.distanceX)),h=a-(l.distanceY-1*Math.sign(l.distanceY)),e.position=this.moveTo(c,h)):0===Math.abs(l.distanceX)?Math.abs(l.distanceY)>s?(h=a-s*Math.sign(l.distanceY),e.position=this.moveTo(i,h)):(h=a-(l.distanceY-1*Math.sign(l.distanceY)),e.position=this.moveTo(i,h)):0===Math.abs(l.distanceY)?Math.abs(l.distanceX)>s?(c=i-s*Math.sign(l.distanceX),e.position=this.moveTo(c,a)):(c=i-(l.distanceX-1*Math.sign(l.distanceX)),e.position=this.moveTo(c,a)):Math.abs(l.distanceX)>Math.sign(l.distanceY)?Math.abs(l.distanceX)>s?(c=i-s*Math.sign(l.distanceX),e.position=this.moveTo(c,a)):(c=i-l.distanceX,e.position=this.moveTo(c,a)):Math.abs(l.distanceY)>s?(h=a-s*Math.sign(l.distanceY),e.position=this.moveTo(i,h)):e.position=this.moveTo(i,a)}checkStr(t){return Math.ceil((t-t%this.gamePlay.boardSize)/this.gamePlay.boardSize)}checkColumn(t){return t%this.gamePlay.boardSize}moveTo(t,e){return t*this.gamePlay.boardSize+e}newGame(){this.blockGame=!1;const t=this.getBestScrore(),e=this.stateService.load();e&&(e.bestScore=t,this.stateService.save(S.from(e))),this.userPositions=[],this.cpuPositions=[],this.stage=1,this.score=0,this.currentTheme=G.prairie,this.letsPlay(),a.showMessage("Уровень 1. Начинаем игру!")}saveGame(){const t=this.getBestScrore(),e={score:this.score,bestScore:t,stage:this.stage,currentTheme:this.currentTheme,userPositions:this.userPositions,computerPositions:this.cpuPositions};this.stateService.save(S.from(e)),a.showMessage("Текущая игра сохранена!")}loadGame(){try{const t=this.stateService.load();t&&(this.score=t.score,this.stage=t.stage,this.currentTheme=t.currentTheme,this.userPositions=t.userPositions,this.cpuPositions=t.computerPositions,this.gamePlay.drawUi(this.currentTheme),this.gamePlay.redrawPositions([...this.userPositions,...this.cpuPositions])),a.showMessage("Игра загружена!")}catch(t){console.log(t),a.showMessage("Не удалось загрузить игру"),this.newGame()}}getBestScrore(){let t=0;try{const e=this.stateService.load();e&&(t=Math.max(e.bestScore,this.score))}catch(e){t=this.score,console.log(e)}return t}}(Y,D).init()}]);